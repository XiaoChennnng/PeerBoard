# PeerBoard 离线协作白板 — 产品需求文档

## 1. 产品名称
- 名称：PeerBoard 离线协作白板
- 口号：随手写、随手贴，局域网即刻协作，数据只在本地
- 定位：纯前端、无后端、无账号的轻量级多人协作白板，用于会议脑暴、教学演示、家庭计划等场景。

## 2. 产品功能列表
- 房间进入与识别
  - 通过 URL 参数自动进入房间：`?room=<房间ID>`（示例：`?room=meet-2025`）。
  - 若未携带参数，提供快速创建房间（自动生成简短ID，如 `room-xxxx`）并复制/分享。
  - 房间仅用于标识会话与导出文件命名，不依赖云端。

- 局域网内多人实时协作（纯前端 P2P）
  - 使用 WebRTC DataChannel 进行点对点同步，无服务器中转数据。
  - 采用“本地信令”方式在同一局域网完成连接建立：
    - 主持人创建房间后，生成包含 WebRTC Offer 的二维码/短码（本地加密封装）。
    - 参与者扫码/输入短码得到必要的信令信息，自动产生 Answer 并通过二维码/短码回传给主持人。
    - 完成握手后，DataChannel 打开，后续所有操作实时互传。
  - 说明：为实现完全离线，信令通过二维码/短码人工/扫码交换，不依赖远端服务；ICE 使用浏览器本地候选（mDNS）。

- 画布与基础绘制
  - 无限画布：支持平移（拖动）、缩放（滚轮/触控手势），带轻量网格与对齐辅助。
  - 绘制工具：铅笔（自由曲线）、标记笔（半透明）、直线/箭头、基础图形（矩形、圆形）、颜色与粗细可选。
  - 文本框：点击插入、双击编辑、自动换行、可调整字号/颜色/背景。
  - 图层/选择：框选、多选、复制、锁定/解锁、置顶/置底、删除。
  - 撤销/重做：对操作序列进行撤销/重做，保持多人一致性。

- 任务贴纸（便利贴）
  - 贴纸创建：选择样式（颜色/形状），编辑文字（如“查竞品”“做PPT”“联系客户”），自由拖拽到任意位置。
  - 彩蛋：双击贴纸自动标记“已完成”，展示删除线与完成徽标。
  - 右键菜单：分配负责人（从本地联系人列表选取，纯前端模拟与存储）。
  - 贴纸列表：右侧栏聚合查看、筛选（全部/未完成/已完成/负责人）。

- 多人态与存在感知
  - 在线用户头像/昵称显示与颜色分配（本地会话名）。
  - 光标预览：他人正在编辑对象的可视化边框与占位标识。
  - 冲突避免：对象“轻锁”机制（正在编辑的对象被软锁，避免同时写入）。

- 本地存储与导出
  - IndexedDB 自动缓存：画布状态、对象列表、联系人等，离线可用，刷新不丢失。
  - 导出：
    - 图片导出（PNG，支持选择区域或整画布、含/不含网格）。
    - JSON 导出（包含房间ID、画布尺寸、对象列表、操作历史的轻量 Schema）。
  - 导入：支持将 JSON 文件导入恢复画布状态（可选择合并或覆盖）。

- 设备与性能
  - 适配桌面与平板（鼠标、触控笔、触控手势），移动端基础支持。
  - 性能优化：增量渲染、批处理绘制、可选简易离屏渲染、对象虚拟化（视口内优先）。

- 安全与隐私
  - 不采集、不上传任何数据到云端，所有内容仅保存在浏览器本地与点对点连接中。
  - 可选本地加密的信令载荷（二维码/短码）以降低被旁观截取的风险。

## 3. 界面设计
- 布局结构（全屏画布 + 叠加浮层）
  - 画布全屏铺满视口（100% 宽高），无外部栏位与侧边区域，所有交互均在画布上完成。
  - 所有 UI 组件以叠加浮层形式存在：工具条、房间分享、导出/导入、贴纸列表、在线成员、状态信息均为可显隐的 overlay，贴靠画布边缘，不占据画布绘制区域。
  - 浮层行为：默认半透明并最小化；触控或悬停展开；支持拖动重定位与贴边吸附；在 PNG 导出时可一键隐藏所有浮层以保证纯画布输出。

- 画布上的工具与面板（皆为 overlay）
  - 主工具条：默认贴靠左上角，以最小图标入口展开为纵向浮层，包含选择/手绘/标记笔/直线/箭头/矩形/圆形/文本/贴纸/颜色盘/粗细/橡皮擦。
  - 属性工具条：选中对象后在对象附近出现微型浮条，提供样式调整与常用操作（复制、删除、置顶/置底、锁定）。
  - 贴纸列表：贴靠右侧边缘的可收起浮层，支持筛选（全部/未完成/已完成/负责人）、搜索与批量标记完成。
  - 在线成员：右上角圆形头像群组浮层，显示昵称颜色与当前工具指示、连接状态（P2P）。
  - 状态信息：右下角小型浮层显示缩放比例、性能指标（FPS/对象数）。

- 弹窗（画布内居中模态 overlay）
  - 房间分享：展示二维码与短码；支持“扫描/输入短码完成连接”。
  - 导出：选择导出类型（PNG/JSON）、范围、文件名（默认携带房间ID）。
  - 导入：拖拽/选择 JSON 文件，预览对象数量与合并策略（覆盖/合并）。
  - 联系人选择：联系人列表作为浮层弹窗显示，可搜索与选取；联系人数据存储在本地。
  - 设置面板：网格开关、吸附强度、默认笔触、文本样式、性能偏好（高/省电），以浮层呈现。

- 视觉与风格
  - 简洁浅色主题，强调可读性与对比度；贴纸颜色丰富但不过度饱和；浮层采用半透明背景与阴影，降低对画布的遮挡感。
  - 光标与选中态采用高可见边框与半透明遮罩，避免误操作。
  - 触控友好：浮层与按钮具备足够尺寸与间距，支持触控笔与手势操作。

## 4. 交互流程设计
- 进入/创建房间
  1) 用户打开网页：若 URL 携带 `room` 参数，则进入对应房间；否则提示“创建房间”，生成简短ID并进入。
  2) 画布右上角浮层显示房间ID与“分享”入口。

- 本地信令与连接建立（完全离线）
  1) 主持人点击“分享”，生成包含 Offer 的二维码与短码。
  2) 参与者在同一局域网打开网页，输入房间ID后点击“加入”，进入连接向导：
     - 扫码主持人二维码或输入主持人短码，生成本地 Answer。
  3) 将参与者 Answer 以二维码/短码回传给主持人（屏幕对屏幕扫码或口述短码）。
  4) 双方完成握手，DataChannel 打开，显示“已连接”。
  5) 后续成员重复上述步骤加入同一房间，形成星型或网状连接。

- 绘制与编辑
  1) 选择工具进行绘制；按住空格可切换为抓手平移；滚轮缩放以当前光标为中心。
  2) 对象选中后可拖拽、缩放、旋转；支持复制/删除；右键打开对象菜单。
  3) 撤销/重做对全体协作生效，使用操作日志保证一致性。

- 文本框
  1) 点击画布插入文本，双击编辑；回车换行、Esc 结束编辑。
  2) 浮动工具条调整样式（字号/颜色/背景）。

- 任务贴纸与彩蛋
  1) 选择贴纸工具，点击画布创建贴纸并编辑内容。
  2) 双击贴纸：自动标记“已完成”，展示删除线与完成标记。
  3) 右键贴纸：“分配负责人”→ 打开本地联系人浮层 → 选择一人 → 在贴纸角标显示负责人昵称（本地存储）。
  4) 贴纸列表浮层可筛选与批量操作（标记完成/取消完成）。

- 多人同步与冲突处理
  - 对象编辑时进行软锁（占用提示），他人不可并行修改同一对象。
  - 同步策略：
    - 操作日志（insert/update/delete）按时间序列传播并合并。
    - 可选轻量 CRDT（如 Yjs/Automerge）以增强离线合并一致性。
  - 网络异常：断线后自动重试；重连时进行状态对齐（基于版本号与增量补丁）。

- 本地缓存与导出/导入
  1) IndexedDB 持久化：房间与画布状态自动保存；刷新后自动恢复。
  2) 导出 PNG：选择整画布/选区、背景网格是否包含、文件名含房间ID。
  3) 导出 JSON：包含对象列表、贴纸状态、负责人映射、操作历史与版本信息。
  4) 导入 JSON：预览后选择“覆盖当前”或“合并到当前”。

- 辅助与帮助
  - 快捷键：如 Ctrl/Cmd+Z 撤销、Ctrl/Cmd+Y 重做、Space 抓手、双击贴纸完成。
  - 新手指引：首次进入展示 60 秒快速引导卡片，可随时查看帮助。

## 5. 所需技术栈
- 前端基础
  - HTML5、CSS、JavaScript（无需后端）。
  - 渲染：Canvas 2D（优先）或 SVG（文本/少量矢量场景）。
  - 事件：Pointer Events（统一鼠标/触控/触控笔），支持多指手势。

- 多人同步
  - WebRTC DataChannel（点对点数据传输）。
  - ICE：不配置远端 STUN/TURN（`iceServers` 为空），使用浏览器提供的本地候选（mDNS）；配合本地信令确保在局域网内建立连接。
  - 信令承载：二维码/短码（离线人工/扫码交换）。
  - 一致性：操作日志合并；可选轻量 CRDT 框架（如 Yjs/Automerge），视体量与许可选择。

- 本地存储与离线能力
  - IndexedDB（建议使用轻量封装库以提升开发效率）。
  - PWA：Service Worker 缓存静态资源，实现完全离线访问与更新提示。

- 工具与依赖（示例）
  - 二维码生成/识别：浏览器端二维码库（生成与扫码，移动端摄像头权限）。
  - 文件处理：PNG 截图与 JSON 导入导出（纯前端实现）。
  - UI 框架：可采用原生或轻量组件库，确保触控友好与性能优先。

- 兼容性与约束
  - 支持现代浏览器（Chrome/Edge/Firefox 的最新版本；Safari 近期版本对 DataChannel 与 mDNS 的兼容需验证）。
  - 无后端前提下，信令交换依赖人为扫描/输入，体验上需通过引导与动画降低心智负担。

---

### 附：JSON 导出建议结构（说明性，仅作格式参考、非代码）
- 房间信息：`roomId`、`createdAt`、`exportedAt`。
- 画布信息：`viewport`（位置/缩放）、`gridEnabled`。
- 对象列表：`objects[]`（类型、几何、样式、文本内容、归属层级、锁定态）。
- 贴纸列表：`stickies[]`（内容、位置、颜色、完成状态、负责人ID）。
- 联系人：`contacts[]`（ID、昵称、本地备注）。
- 操作历史：`ops[]`（增/改/删、对象ID、时间戳、操作者）。
- 版本信息：`schemaVersion`、`appVersion`。

### 非功能性需求
- 性能：中等复杂度画布（数百对象）维持流畅交互，FPS>30。
- 可用性：关键操作可撤销、可恢复；异常断线后自动重连不丢数据。
- 隐私：默认不收集用户数据；导出文件由用户本地持有。
- 可维护性：模块化设计（渲染、同步、存储、UI 分层），便于后续迭代。

### 里程碑建议
- M1 基础单人白板（画布/文本/贴纸/缓存/导出）。
- M2 本地信令 + 双端 P2P 同步（操作日志一致性）。
- M3 多人协作体验优化（存在感、软锁、贴纸列表）。
- M4 PWA 与移动端优化、性能打磨、可用性完善。